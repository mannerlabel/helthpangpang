# 영상 미팅 성능 및 안정성 분석 보고서

## 1. 현재 시스템 구조 분석

### 1.1 동시 실행 중인 리소스

#### A. 카메라 스트림
- **TrainingPage**: 자세 측정용 카메라 스트림 (1280x720, 30fps)
- **CrewMeetingView**: 참여자 미팅용 카메라 스트림 (저화질: 480x270 또는 중화질: 640x360)
- **문제점**: 두 개의 카메라 스트림이 동시에 실행될 수 있음
- **해결책**: `sharedVideoStream`을 통해 스트림 공유 (이미 구현됨)

#### B. 미디어파이프 포즈 인식
- **실행 주기**: 18fps (약 55.5ms 간격)
- **처리 시간**: MoveNet Lightning 모델 사용 (가벼운 모델)
- **GPU 사용**: WebGL 백엔드 사용
- **예상 CPU 사용량**: 중간 (GPU 가속 사용 시 낮음)
- **예상 메모리 사용량**: 약 50-100MB (모델 로드)

#### C. WebRTC 연결
- **PeerConnection 수**: 참여자 수만큼 (2명 = 2개)
- **스트림 전송**: 각 PeerConnection마다 비디오 + 오디오 트랙
- **네트워크 대역폭**: 
  - 저화질 (480x270): 약 500Kbps
  - 중화질 (640x360): 약 1Mbps
  - 고화질 (1280x720): 약 2Mbps
- **2명 기준**: 약 1-2Mbps (양방향)

#### D. 실시간 채팅
- **폴링 주기**: 
  - 채팅창 열림: 2초마다
  - 채팅창 닫힘: 3초마다
- **네트워크 요청**: Supabase REST API 호출
- **예상 대역폭**: 매우 낮음 (텍스트 메시지)

#### E. 배경음악
- **재생 방식**: Howler.js 사용
- **파일 크기**: MP3 파일 (일반적으로 3-5MB)
- **메모리 사용량**: 약 10-20MB (버퍼링)
- **CPU 사용량**: 낮음 (디코딩은 하드웨어 가속)

#### F. Signaling (Supabase Realtime)
- **연결 방식**: WebSocket
- **메시지 빈도**: 낮음 (Offer/Answer/ICE candidate만)
- **대역폭**: 매우 낮음 (텍스트 기반 JSON)

### 1.2 리소스 사용량 추정

#### CPU 사용량
1. **미디어파이프 포즈 인식**: 15-25% (GPU 가속 시 5-10%)
2. **비디오 인코딩/디코딩**: 10-20% (하드웨어 가속 시 2-5%)
3. **WebRTC 처리**: 5-10%
4. **배경음악**: 1-2%
5. **기타 (React 렌더링 등)**: 5-10%
**총 예상 CPU 사용량**: 36-67% (하드웨어 가속 시 13-27%)

#### 메모리 사용량
1. **미디어파이프 모델**: 50-100MB
2. **비디오 버퍼**: 20-50MB (각 스트림)
3. **배경음악**: 10-20MB
4. **WebRTC 버퍼**: 10-30MB
5. **React 상태/컴포넌트**: 20-50MB
**총 예상 메모리 사용량**: 110-250MB

#### 네트워크 대역폭
1. **WebRTC 비디오**: 1-2Mbps (양방향)
2. **WebRTC 오디오**: 50-100Kbps (양방향)
3. **Signaling**: <10Kbps
4. **채팅 폴링**: <1Kbps
**총 예상 대역폭**: 약 1.1-2.1Mbps (양방향)

## 2. 문제점 분석

### 2.1 카메라 리소스 경쟁
**문제**: 
- TrainingPage와 CrewMeetingView가 각각 카메라 스트림을 요청할 수 있음
- 브라우저가 카메라 접근을 제한하거나 기존 스트림을 종료시킬 수 있음

**현재 해결책**: 
- `sharedVideoStream`을 통해 스트림 공유 (부분적으로 해결됨)
- 하지만 여전히 일부 경우에 중복 스트림 생성 가능

### 2.2 WebRTC 연결 불안정
**문제**:
- STUN 서버만 사용 (TURN 서버 없음)
- NAT 뒤 환경에서 연결 실패 가능
- Offer/Answer 교환 실패 시 재시도 로직이 복잡함

**현재 상태**:
- Offer 타임아웃 처리 추가됨 (10초)
- 재시도 로직 개선됨
- 하지만 여전히 연결 실패 가능

### 2.3 미디어파이프 포즈 인식 부하
**문제**:
- 18fps로 지속적으로 실행
- GPU 메모리 사용
- 비디오 프레임 처리 부하

**영향**:
- CPU/GPU 사용량 증가
- 다른 프로세스(WebRTC 등)에 영향 가능

### 2.4 실시간 채팅 폴링
**문제**:
- 2-3초마다 API 호출
- 여러 사용자가 동시에 폴링하면 서버 부하

**영향**:
- 네트워크 요청 증가
- Supabase 부하 증가

### 2.5 배경음악
**문제**:
- MP3 파일 재생
- 메모리 버퍼링

**영향**:
- 메모리 사용량 증가
- 오디오 리소스 경쟁 가능

## 3. 성능 병목 지점

### 3.1 주요 병목
1. **미디어파이프 포즈 인식** (18fps)
   - GPU 메모리 사용
   - 비디오 프레임 처리
   - **우선순위: 높음**

2. **WebRTC 비디오 인코딩/디코딩**
   - 하드웨어 가속 사용 시 낮음
   - 소프트웨어 인코딩 시 높음
   - **우선순위: 중간**

3. **카메라 스트림 중복**
   - 리소스 경쟁
   - **우선순위: 높음**

4. **실시간 채팅 폴링**
   - 네트워크 요청
   - **우선순위: 낮음**

5. **배경음악**
   - 메모리 사용
   - **우선순위: 낮음**

## 4. 개선 방안

### 4.1 즉시 개선 가능한 사항

#### A. 미디어파이프 포즈 인식 최적화
- **현재**: 18fps
- **제안**: 10-12fps로 감소 (자세 측정에는 충분)
- **예상 효과**: CPU/GPU 사용량 30-40% 감소

#### B. 실시간 채팅 폴링 최적화
- **현재**: 2-3초마다
- **제안**: Supabase Realtime 구독으로 변경 (폴링 제거)
- **예상 효과**: 네트워크 요청 90% 감소

#### C. 카메라 스트림 공유 강화
- **현재**: 부분적으로 구현됨
- **제안**: 항상 `sharedVideoStream` 사용 강제
- **예상 효과**: 카메라 리소스 경쟁 완전 제거

#### D. WebRTC 화질 자동 조정
- **현재**: 저화질 고정
- **제안**: 네트워크 상태에 따라 자동 조정
- **예상 효과**: 연결 안정성 향상

### 4.2 중장기 개선 사항

#### A. TURN 서버 추가
- **목적**: NAT 뒤 환경에서 연결 보장
- **비용**: TURN 서버 운영 비용 필요

#### B. 미디어파이프 워커 스레드 사용
- **목적**: 메인 스레드 부하 감소
- **구현 난이도**: 높음

#### C. 비디오 스트림 품질 동적 조정
- **목적**: 네트워크 상태에 따라 자동 조정
- **구현 난이도**: 중간

## 5. 수치적 분석 요약

### 5.1 리소스 사용량 (2명 기준)

| 리소스 | 사용량 | 우선순위 |
|--------|--------|----------|
| CPU | 36-67% (하드웨어 가속 시 13-27%) | 높음 |
| 메모리 | 110-250MB | 중간 |
| 네트워크 | 1.1-2.1Mbps (양방향) | 중간 |
| GPU | 중간 (미디어파이프) | 중간 |

### 5.2 병목 지점 순위

1. **미디어파이프 포즈 인식** (18fps) - 최우선 개선
2. **카메라 스트림 중복** - 즉시 개선 가능
3. **WebRTC 연결 불안정** - TURN 서버 필요
4. **실시간 채팅 폴링** - Realtime 구독으로 변경
5. **배경음악** - 영향 낮음

### 5.3 예상 개선 효과

| 개선 사항 | CPU 감소 | 메모리 감소 | 네트워크 감소 |
|-----------|----------|-------------|---------------|
| 포즈 인식 10fps로 감소 | 30-40% | - | - |
| 채팅 Realtime 구독 | - | - | 90% |
| 카메라 스트림 공유 강화 | 5-10% | 20-50MB | - |
| **총합** | **35-50%** | **20-50MB** | **90%** |

## 6. 발견된 주요 문제점

### 6.1 과도한 주기적 호출
1. **loadParticipants**: 2초마다 호출 (참여자 섹션 펼침 시)
2. **채팅 메시지 폴링**: 2-3초마다 API 호출
3. **활성 상태 업데이트**: 5초마다 Supabase 업데이트
4. **미디어파이프 포즈 인식**: 18fps (약 55ms마다)

**총 주기적 작업**:
- 2초마다: loadParticipants + 채팅 폴링
- 3초마다: 채팅 폴링 (채팅창 닫힘 시)
- 5초마다: 활성 상태 업데이트
- 55ms마다: 포즈 인식

**영향**: CPU/네트워크 부하 증가

### 6.2 카메라 스트림 중복 생성 가능성
- `sharedVideoStream`이 있음에도 불구하고 `CrewMeetingView`에서 별도 스트림 생성 가능
- 조건: `sharedVideoStream && myVideoEnabled`일 때만 공유 스트림 사용
- 문제: `sharedVideoStream`이 null이거나 조건이 맞지 않으면 중복 생성

### 6.3 WebRTC 연결 불안정
- STUN 서버만 사용 (TURN 서버 없음)
- NAT 뒤 환경에서 연결 실패 가능
- Offer 타임아웃 처리 추가되었지만 여전히 불안정

### 6.4 메모리 누수 가능성
- `setInterval`이 여러 곳에서 사용됨
- cleanup이 제대로 되지 않을 수 있음
- 비디오 스트림이 정리되지 않을 수 있음

## 7. 수치적 분석 결과

### 7.1 CPU 사용량 (2명 기준, 하드웨어 가속 가정)

| 작업 | 주기 | CPU 사용량 | 비고 |
|------|------|------------|------|
| 미디어파이프 포즈 인식 | 55ms (18fps) | 15-25% | GPU 가속 시 5-10% |
| 비디오 인코딩/디코딩 | 연속 | 10-20% | 하드웨어 가속 시 2-5% |
| WebRTC 처리 | 연속 | 5-10% | - |
| loadParticipants | 2초 | 1-2% | 데이터베이스 쿼리 |
| 채팅 폴링 | 2-3초 | 0.5-1% | API 호출 |
| 활성 상태 업데이트 | 5초 | 0.5-1% | Supabase 업데이트 |
| 배경음악 | 연속 | 1-2% | 하드웨어 디코딩 |
| React 렌더링 | 상태 변경 시 | 5-10% | - |
| **총합** | - | **38-71%** | 하드웨어 가속 시 **14-29%** |

### 7.2 메모리 사용량 (2명 기준)

| 리소스 | 메모리 사용량 | 비고 |
|--------|---------------|------|
| 미디어파이프 모델 | 50-100MB | GPU 메모리 포함 |
| 비디오 버퍼 (자세 측정) | 20-50MB | 1280x720 스트림 |
| 비디오 버퍼 (미팅) | 10-30MB | 480x270 스트림 |
| WebRTC 버퍼 | 10-30MB | 양방향 스트림 |
| 배경음악 | 10-20MB | MP3 버퍼링 |
| React 상태/컴포넌트 | 20-50MB | - |
| **총합** | **120-280MB** | - |

### 7.3 네트워크 대역폭 (2명 기준)

| 리소스 | 대역폭 | 방향 |
|--------|--------|------|
| WebRTC 비디오 | 1-2Mbps | 양방향 |
| WebRTC 오디오 | 50-100Kbps | 양방향 |
| Signaling (WebSocket) | <10Kbps | 양방향 |
| 채팅 폴링 | <1Kbps | 단방향 (요청) |
| 활성 상태 업데이트 | <1Kbps | 단방향 (요청) |
| **총합** | **약 1.1-2.1Mbps** | 양방향 |

### 7.4 주기적 작업 빈도

| 작업 | 빈도 | 초당 호출 수 |
|------|------|-------------|
| 포즈 인식 | 18fps | 18회 |
| loadParticipants | 2초마다 | 0.5회 |
| 채팅 폴링 | 2-3초마다 | 0.33-0.5회 |
| 활성 상태 업데이트 | 5초마다 | 0.2회 |
| **총합** | - | **약 19-19.2회/초** |

## 8. 주요 병목 지점

### 우선순위 1: 미디어파이프 포즈 인식 (18fps)
- **영향**: CPU/GPU 사용량 15-25%
- **개선 효과**: 10fps로 감소 시 CPU/GPU 사용량 30-40% 감소
- **권장**: 즉시 적용

### 우선순위 2: 카메라 스트림 중복
- **영향**: 리소스 경쟁, 메모리 사용량 증가
- **개선 효과**: 중복 제거 시 메모리 20-50MB 절약
- **권장**: 즉시 적용

### 우선순위 3: 과도한 주기적 호출
- **영향**: CPU/네트워크 부하
- **개선 효과**: 
  - loadParticipants: 2초 → 5초 (60% 감소)
  - 채팅 폴링: Realtime 구독으로 변경 (90% 감소)
- **권장**: 즉시 적용

### 우선순위 4: WebRTC 연결 불안정
- **영향**: 영상/음성 끊김
- **개선 효과**: TURN 서버 추가 시 연결 성공률 90%+ 향상
- **권장**: 단기 개선

## 9. 즉시 적용 가능한 개선 사항

### 9.1 미디어파이프 포즈 인식 최적화
```typescript
// usePoseDetection.ts
const targetFPS = 10 // 18fps → 10fps로 감소
const frameInterval = 1000 / targetFPS // 100ms
```
**예상 효과**: CPU/GPU 사용량 30-40% 감소

### 9.2 loadParticipants 주기 증가
```typescript
// CrewMeetingView.tsx
}, 5000) // 2초 → 5초로 증가
```
**예상 효과**: CPU/네트워크 부하 60% 감소

### 9.3 카메라 스트림 공유 강제
```typescript
// CrewMeetingView.tsx
// sharedVideoStream이 있으면 항상 사용하도록 강제
if (sharedVideoStream) {
  // 항상 공유 스트림 사용
  return
}
```
**예상 효과**: 메모리 20-50MB 절약, 리소스 경쟁 제거

### 9.4 채팅 Realtime 구독으로 변경
- 현재: 2-3초마다 폴링
- 개선: Supabase Realtime 구독으로 변경
- **예상 효과**: 네트워크 요청 90% 감소

## 10. 권장 사항

### 즉시 적용 가능:
1. ✅ 미디어파이프 포즈 인식 주기 18fps → 10fps로 감소
2. ✅ loadParticipants 주기 2초 → 5초로 증가
3. ✅ 카메라 스트림 공유 강제 적용
4. ✅ 채팅 폴링 → Supabase Realtime 구독으로 변경

### 단기 개선:
1. WebRTC 화질 자동 조정
2. 네트워크 상태 모니터링 및 자동 조정
3. 메모리 누수 방지 (cleanup 강화)

### 장기 개선:
1. TURN 서버 추가
2. 미디어파이프 워커 스레드 사용
3. 비디오 스트림 품질 동적 조정

