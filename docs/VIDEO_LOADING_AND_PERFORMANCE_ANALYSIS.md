# 영상 로딩 문제 및 성능 영향 분석

## 1. 현재 구조 분석

### 1.1 카메라 스트림 구조

현재 시스템은 **두 개의 별도 카메라 스트림**을 사용하고 있습니다:

#### 자세 측정용 카메라 스트림
- **위치**: `src/pages/TrainingPage.tsx` → `useCamera` 훅
- **서비스**: `src/services/cameraService.ts`
- **해상도**: 1280x720 (고정)
- **프레임레이트**: 30fps
- **용도**: 자세 인식 (Pose Detection)
- **비디오 요소**: `cameraVideoRef`

#### 참여자 화면용 카메라 스트림
- **위치**: `src/components/CrewMeetingView.tsx`
- **직접 호출**: `navigator.mediaDevices.getUserMedia()`
- **해상도**: 동적 (480x270 ~ 1280x720)
- **프레임레이트**: 동적 (15fps ~ 30fps)
- **용도**: WebRTC를 통한 참여자 간 영상 공유
- **비디오 요소**: `myVideoRef`

### 1.2 성능 영향 분석

#### CPU/GPU 부하

1. **자세 측정 (Pose Detection)**
   - **모델**: TensorFlow.js MoveNet Lightning
   - **실행 주기**: `requestAnimationFrame` (약 30fps)
   - **GPU 사용**: WebGL 백엔드 사용
   - **예상 부하**: 
     - CPU: 중간 (약 15-20%)
     - GPU: 높음 (약 30-40%)
     - 메모리: 약 200-300MB

2. **참여자 화면 영상 (WebRTC)**
   - **인코딩**: VP8/VP9/H.264 하드웨어 가속
   - **해상도**: 동적 (참여자 수에 따라 조정)
   - **예상 부하**:
     - CPU: 낮음-중간 (약 5-15%, 해상도에 따라)
     - GPU: 중간 (약 10-20%, 하드웨어 가속 시)
     - 메모리: 약 50-100MB

3. **두 스트림 동시 실행 시**
   - **총 CPU 부하**: 약 20-35%
   - **총 GPU 부하**: 약 40-60%
   - **총 메모리**: 약 250-400MB
   - **카메라 리소스 경쟁**: 가능성 있음

#### 네트워크 부하

- **자세 측정 스트림**: 로컬 처리만 (네트워크 전송 없음)
- **참여자 화면 스트림**: WebRTC로 전송
  - 저화질 (480x270): 약 500Kbps
  - 중화질 (640x360): 약 1Mbps
  - 고화질 (1280x720): 약 2Mbps

### 1.3 영상 로딩 문제 분석

#### 문제점

1. **입장 시 초기 스트림 획득 실패**
   - `CrewMeetingView`의 `useEffect`가 `myVideoEnabled` 변경 시에만 실행
   - 입장 시 초기값이 제대로 반영되지 않을 수 있음
   - 스트림 획득 실패 시 재시도 로직이 있지만 완벽하지 않음

2. **중간에 영상이 로딩되지 않는 경우**
   - 스트림이 비활성화되거나 종료되는 경우 감지하지 못함
   - `remoteStreams` 업데이트가 지연되는 경우
   - WebRTC 연결이 끊어지는 경우

3. **카메라 리소스 경쟁**
   - 두 개의 스트림이 동시에 카메라에 접근
   - 일부 브라우저/디바이스에서 카메라 접근 제한
   - 스트림 획득 실패 가능성 증가

## 2. 해결 방안

### 2.1 입장 시 초기 스트림 획득 보장

#### 개선 사항

1. **초기 마운트 시 스트림 획득 강제**
   ```typescript
   useEffect(() => {
     // 입장 시 초기값이 true이면 즉시 스트림 획득
     if (myVideoEnabled && !myVideoStream) {
       // 스트림 획득 로직 실행
     }
   }, []) // 마운트 시 한 번만 실행
   ```

2. **스트림 획득 실패 시 재시도 로직 개선**
   - 재시도 횟수 증가 (2회 → 5회)
   - 재시도 간격 조정 (1초 → 2초)
   - 에러 타입별 다른 처리

3. **스트림 상태 모니터링**
   - `MediaStreamTrack.onended` 이벤트 리스너 추가
   - 스트림이 종료되면 자동으로 재획득

### 2.2 카메라 스트림 공유 (권장)

#### 개선 방안

**같은 카메라 스트림을 자세 측정과 참여자 화면에 공유**

장점:
- 카메라 리소스 경쟁 제거
- 메모리 사용량 감소
- 성능 향상

단점:
- 해상도가 자세 측정에 맞춰져야 함 (1280x720 고정)
- 참여자 수에 따른 동적 해상도 조정 불가능

구현 방법:
```typescript
// TrainingPage에서 카메라 스트림을 CrewMeetingView에 전달
const { state: cameraState, videoRef: cameraVideoRef, start: startCamera } = useCamera({
  width: 1280,
  height: 720,
  facingMode: 'user',
})

// CrewMeetingView에 스트림 전달
<CrewMeetingView
  crewId={crewId}
  myVideoStream={cameraState.stream} // 공유 스트림
  // ...
/>
```

### 2.3 성능 최적화

#### 개선 사항

1. **자세 측정 프레임레이트 조정**
   - 현재: 30fps (requestAnimationFrame)
   - 권장: 15-20fps (자세 측정에는 충분)
   - 구현: `setTimeout`으로 프레임레이트 제한

2. **참여자 화면 해상도 동적 조정**
   - 현재: 참여자 수에 따라 자동 조정
   - 유지: 현재 로직 유지

3. **스트림 일시 중지**
   - 자세 측정이 비활성화되면 스트림 일시 중지
   - 참여자 화면이 비활성화되면 스트림 일시 중지

## 3. 성능 영향 요약

### 3.1 현재 구조 (두 개의 별도 스트림)

| 항목 | 자세 측정 | 참여자 화면 | 합계 |
|------|----------|------------|------|
| CPU 부하 | 15-20% | 5-15% | 20-35% |
| GPU 부하 | 30-40% | 10-20% | 40-60% |
| 메모리 | 200-300MB | 50-100MB | 250-400MB |
| 카메라 리소스 | 1개 | 1개 | 2개 (경쟁 가능) |

### 3.2 개선 후 구조 (스트림 공유)

| 항목 | 자세 측정 | 참여자 화면 | 합계 |
|------|----------|------------|------|
| CPU 부하 | 15-20% | 5-10% | 20-30% |
| GPU 부하 | 30-40% | 5-10% | 35-50% |
| 메모리 | 200-300MB | 0MB (공유) | 200-300MB |
| 카메라 리소스 | 1개 (공유) | 1개 (공유) | 1개 |

### 3.3 성능 개선 효과

- **CPU 부하**: 약 5-10% 감소
- **GPU 부하**: 약 5-10% 감소
- **메모리 사용량**: 약 50-100MB 감소
- **카메라 리소스 경쟁**: 제거
- **영상 로딩 안정성**: 향상

## 4. 권장 사항

1. **단기 개선** (즉시 적용 가능)
   - 입장 시 초기 스트림 획득 보장
   - 스트림 상태 모니터링 추가
   - 재시도 로직 개선

2. **중기 개선** (성능 최적화)
   - 자세 측정 프레임레이트 조정 (30fps → 15-20fps)
   - 스트림 일시 중지 기능 추가

3. **장기 개선** (구조 개선)
   - 카메라 스트림 공유 구현
   - 해상도 동적 조정 로직 재검토

