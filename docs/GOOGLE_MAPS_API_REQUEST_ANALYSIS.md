# Google Maps API 요청 분석 및 비용 산출

## 📊 현재 구현 분석

### 1. API 사용 위치

#### 1.1 JoggingModeSelectPage.tsx
- **스크립트 로드**: 페이지 로드 시 1회 (중복 체크로 인해 실제로는 첫 방문 시에만)
- **맵 인스턴스 생성**: 모달 열 때마다 `new google.maps.Map()` 호출
- **요청 발생 시점**: 
  - 사용자가 "Map" 버튼 클릭 → 모달 열림 → 맵 인스턴스 생성

#### 1.2 JoggingAlonePage.tsx
- **스크립트 로드**: MapDisplay 컴포넌트 마운트 시 체크 (중복 체크로 인해 실제로는 첫 방문 시에만)
- **맵 인스턴스 생성**: MapDisplay 컴포넌트가 렌더링될 때마다 `new google.maps.Map()` 호출
- **요청 발생 시점**:
  - 사용자가 목표 목록에서 "Map" 버튼 클릭 → 모달 열림 → 맵 인스턴스 생성

#### 1.3 JoggingGoalCreatePage.tsx
- **스크립트 로드**: MapDisplay 컴포넌트 마운트 시 체크 (중복 체크로 인해 실제로는 첫 방문 시에만)
- **맵 인스턴스 생성**: MapDisplay 컴포넌트가 렌더링될 때마다 `new google.maps.Map()` 호출
- **요청 발생 시점**:
  - 사용자가 "Map" 버튼 클릭 → 모달 열림 → 맵 인스턴스 생성

### 2. 요청 횟수 계산

#### 2.1 스크립트 로드 요청
```
요청 유형: GET https://maps.googleapis.com/maps/api/js?key=...&libraries=geometry
요청 횟수: 세션당 1회 (브라우저 캐시 고려 시 더 적음)
비용: Maps JavaScript API 스크립트 로드는 무료 (단, 맵 인스턴스 생성 시 요청 발생)
```

**중복 체크 로직:**
```typescript
// 이미 로드되어 있는지 확인
if (window.google && window.google.maps) {
  return
}

// 이미 스크립트가 있는지 확인
const existingScript = document.querySelector('script[src*="maps.googleapis.com"]')
if (existingScript) {
  return
}
```

#### 2.2 맵 인스턴스 생성 요청
```
요청 유형: Maps JavaScript API - Map Load
요청 발생: new google.maps.Map() 호출 시
요청 횟수: 맵 모달을 열 때마다 1회
```

**요청 발생 시나리오:**

| 페이지 | 액션 | 요청 횟수 |
|--------|------|-----------|
| JoggingModeSelectPage | 공유 코스 목록에서 "Map" 버튼 클릭 | 1회/모달 열기 |
| JoggingAlonePage | 목표 목록에서 "Map" 버튼 클릭 | 1회/모달 열기 |
| JoggingGoalCreatePage | "Map" 버튼 클릭 | 1회/모달 열기 |

**참고:**
- Polyline, Marker 생성은 추가 요청이 아닙니다 (맵 인스턴스 내부 객체)
- `fitBounds()` 호출도 추가 요청이 아닙니다 (클라이언트 사이드 계산)

### 3. Google Maps API 가격 정책 (2024 기준)

#### 3.1 Maps JavaScript API
- **무료 크레딧**: 월 $200 (약 28,571회 요청)
- **초과 요금**: $7/1,000 요청
- **요청 단위**: 맵 인스턴스 생성 시 1회 요청

#### 3.2 Maps Embed API
- **비용**: 무료 (현재 사용하지 않음)

### 4. 비용 산출

#### 4.1 시나리오별 요청 횟수

**시나리오 1: 일반적인 사용 패턴**
```
- 일일 활성 사용자: 100명
- 사용자당 평균 맵 조회: 3회/일
- 일일 총 맵 조회: 300회
- 월간 총 맵 조회: 9,000회
```

**시나리오 2: 높은 사용량**
```
- 일일 활성 사용자: 500명
- 사용자당 평균 맵 조회: 5회/일
- 일일 총 맵 조회: 2,500회
- 월간 총 맵 조회: 75,000회
```

#### 4.2 비용 계산

**시나리오 1 (일일 300회, 월간 9,000회):**
```
월간 요청: 9,000회
무료 크레딧: $200 (28,571회)
초과 요청: 0회
월간 비용: $0
```

**시나리오 2 (일일 2,500회, 월간 75,000회):**
```
월간 요청: 75,000회
무료 크레딧: $200 (28,571회)
초과 요청: 75,000 - 28,571 = 46,429회
초과 비용: (46,429 / 1,000) × $7 = $325.00
월간 총 비용: $325.00
```

**시나리오 3: 매우 높은 사용량 (일일 10,000회, 월간 300,000회):**
```
월간 요청: 300,000회
무료 크레딧: $200 (28,571회)
초과 요청: 300,000 - 28,571 = 271,429회
초과 비용: (271,429 / 1,000) × $7 = $1,900.00
월간 총 비용: $1,900.00
```

### 5. 최적화 전략

#### 5.1 현재 구현의 최적화 포인트

✅ **이미 구현된 최적화:**
1. 스크립트 중복 로드 방지
2. 맵 인스턴스 정리 (메모리 누수 방지)
3. 모달 닫을 때 맵 인스턴스 제거

#### 5.2 추가 최적화 방안

**1. 맵 인스턴스 재사용 (고려사항)**
```typescript
// 현재: 모달 열 때마다 새 맵 인스턴스 생성
// 개선: 같은 경로의 맵은 재사용 (복잡도 증가)
```
- **장점**: 요청 횟수 감소
- **단점**: 코드 복잡도 증가, 메모리 관리 복잡

**2. 맵 지연 로딩 (Lazy Loading)**
```typescript
// 모달이 실제로 열렸을 때만 맵 인스턴스 생성
// 현재도 이미 구현되어 있음 (showCourseModal 조건)
```

**3. 맵 캐싱 (고려사항)**
```typescript
// 같은 경로의 맵을 캐시하여 재사용
// 하지만 Google Maps API는 맵 인스턴스 생성 시마다 요청 발생
```

**4. 사용량 모니터링**
- Google Cloud Console에서 API 사용량 모니터링
- 일일/월간 요청 수 추적
- 예산 알림 설정

### 6. 요청 추적 방법

#### 6.1 Google Cloud Console
1. Google Cloud Console 접속
2. APIs & Services > Dashboard
3. Maps JavaScript API 선택
4. 사용량 및 비용 확인

#### 6.2 코드 레벨 추적 (선택사항)
```typescript
// 맵 인스턴스 생성 시 로깅
const map = new google.maps.Map(mapRef.current, {...})
console.log('🗺️ Map instance created:', new Date().toISOString())
```

### 7. 예상 비용 요약

| 사용량 | 일일 요청 | 월간 요청 | 월간 비용 |
|--------|-----------|-----------|-----------|
| 낮음 | 100회 | 3,000회 | $0 |
| 보통 | 300회 | 9,000회 | $0 |
| 높음 | 2,500회 | 75,000회 | $325 |
| 매우 높음 | 10,000회 | 300,000회 | $1,900 |

### 8. 권장사항

1. **예산 알림 설정**
   - Google Cloud Console에서 예산 알림 설정
   - 월간 $100, $200, $500 등 단계별 알림

2. **사용량 모니터링**
   - 주간/월간 사용량 리포트 확인
   - 비정상적인 사용량 패턴 감지

3. **최적화 우선순위**
   - 현재 구현은 이미 최적화되어 있음
   - 사용량이 월 28,571회를 초과할 경우 추가 최적화 고려

4. **비용 관리**
   - 무료 크레딧 범위 내에서 사용 권장
   - 초과 사용 시 사용자당 제한 또는 캐싱 전략 고려

### 9. 결론

**현재 구현:**
- ✅ 스크립트 중복 로드 방지
- ✅ 맵 인스턴스 정리
- ✅ 지연 로딩 (모달 열 때만)

**예상 비용:**
- 일반적인 사용량 (월 9,000회 이하): **$0**
- 높은 사용량 (월 75,000회): **$325/월**
- 매우 높은 사용량 (월 300,000회): **$1,900/월**

**권장 조치:**
1. Google Cloud Console에서 예산 알림 설정
2. 주간 사용량 모니터링
3. 월간 28,571회 이하로 유지 권장 (무료 크레딧 범위)

