# WebRTC ì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ ë¬¸ì„œ

## ğŸ“‹ ëª©ì°¨
1. [ê°œìš”](#ê°œìš”)
2. [ë¯¸ë””ì–´ ì„¤ì • (ì½”ë±, í•´ìƒë„, í”„ë ˆì„ë ˆì´íŠ¸)](#ë¯¸ë””ì–´-ì„¤ì •)
3. [P2P êµ¬ì¡° ë¶„ì„](#p2p-êµ¬ì¡°-ë¶„ì„)
4. [ì„œë¹„ìŠ¤ êµ¬ì¡°](#ì„œë¹„ìŠ¤-êµ¬ì¡°)
5. [ë°ì´í„° íë¦„](#ë°ì´í„°-íë¦„)
6. [ìƒíƒœ ê´€ë¦¬ ë° ë³´í˜¸ ë©”ì»¤ë‹ˆì¦˜](#ìƒíƒœ-ê´€ë¦¬-ë°-ë³´í˜¸-ë©”ì»¤ë‹ˆì¦˜)

---

## ê°œìš”

WebRTC ì„œë¹„ìŠ¤ëŠ” ë¸Œë¼ìš°ì € ê°„ ì‹¤ì‹œê°„ ë¯¸ë””ì–´ í†µì‹ ì„ ìœ„í•œ P2P ì—°ê²°ì„ ê´€ë¦¬í•˜ëŠ” ì‹±ê¸€í†¤ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. Supabase Realtimeì„ Signaling ì±„ë„ë¡œ ì‚¬ìš©í•˜ì—¬ WebRTC ì—°ê²°ì„ ì„¤ì •í•©ë‹ˆë‹¤.

### ì£¼ìš” íŠ¹ì§•
- **ì‹±ê¸€í†¤ íŒ¨í„´**: `webrtcService` ì¸ìŠ¤í„´ìŠ¤ í•˜ë‚˜ë§Œ ì‚¬ìš©
- **Map ê¸°ë°˜ ê´€ë¦¬**: `userId` â†’ `RTCPeerConnection` ë§¤í•‘
- **ì½œë°± ì‹œìŠ¤í…œ**: ìƒíƒœ ë³€ê²½ ë° ì›ê²© ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹  ì•Œë¦¼
- **ìƒíƒœ ë³´í˜¸**: ìƒì„± ì‹œë„ ì œí•œ, ë™ì‹œ ì‹¤í–‰ ë°©ì§€, ìƒíƒœ ê²€ì¦
- **ìë™ ì •ë¦¬**: ë‹«íŒ ì—°ê²° ê°ì§€ ë° ì •ë¦¬

---

## ë¯¸ë””ì–´ ì„¤ì •

### í˜„ì¬ ì„¤ì •ê°’ (ë™ì  ì¡°ì •)

#### 1. ë¹„ë””ì˜¤ í•´ìƒë„ ë° í”„ë ˆì„ë ˆì´íŠ¸ (ì°¸ì—¬ì ìˆ˜ì— ë”°ë¼ ë™ì  ì¡°ì •)

**ì°¸ì—¬ì ìˆ˜ì— ë”°ë¥¸ í’ˆì§ˆ ì¡°ì •:**

| ì°¸ì—¬ì ìˆ˜ | í•´ìƒë„ | í”„ë ˆì„ë ˆì´íŠ¸ | ë¹„íŠ¸ë ˆì´íŠ¸ | ìš©ë„ |
|---------|--------|------------|-----------|------|
| 1-2ëª… | 1280x720 | 30fps | 2Mbps | ê³ í™”ì§ˆ (1:1 ë˜ëŠ” ì†Œê·œëª¨) |
| 3-4ëª… | 640x360 | 20fps | 1Mbps | ì¤‘ê°„ í™”ì§ˆ (ì¤‘ê·œëª¨) |
| 5ëª… ì´ìƒ | 480x270 | 15fps | 500Kbps | ì €í™”ì§ˆ (ëŒ€ê·œëª¨) |

**êµ¬í˜„ ì½”ë“œ:**
```typescript
// CrewMeetingView.tsx
const getVideoQuality = (participantCount: number) => {
  const activeVideoCount = participantCount
  
  if (activeVideoCount <= 2) {
    // 1-2ëª…: ê³ í™”ì§ˆ
    return {
      width: { ideal: 1280, min: 640, max: 1920 },
      height: { ideal: 720, min: 360, max: 1080 },
      frameRate: { ideal: 30, max: 30, min: 20 },
      bitrate: 2000000, // 2Mbps
    }
  } else if (activeVideoCount <= 4) {
    // 3-4ëª…: ì¤‘ê°„ í™”ì§ˆ
    return {
      width: { ideal: 640, min: 480, max: 1280 },
      height: { ideal: 360, min: 270, max: 720 },
      frameRate: { ideal: 20, max: 25, min: 15 },
      bitrate: 1000000, // 1Mbps
    }
  } else {
    // 5ëª… ì´ìƒ: ì €í™”ì§ˆ
    return {
      width: { ideal: 480, min: 320, max: 640 },
      height: { ideal: 270, min: 180, max: 360 },
      frameRate: { ideal: 15, max: 20, min: 10 },
      bitrate: 500000, // 500Kbps
    }
  }
}
```

**ì„¤ì •ê°’:**
- **í•´ìƒë„**: ì°¸ì—¬ì ìˆ˜ì— ë”°ë¼ ë™ì  ì¡°ì • (1280x720 â†’ 640x360 â†’ 480x270)
- **í”„ë ˆì„ë ˆì´íŠ¸**: ì°¸ì—¬ì ìˆ˜ì— ë”°ë¼ ë™ì  ì¡°ì • (30fps â†’ 20fps â†’ 15fps)
- **ë¹„íŠ¸ë ˆì´íŠ¸**: ì°¸ì—¬ì ìˆ˜ì— ë”°ë¼ ë™ì  ì¡°ì • (2Mbps â†’ 1Mbps â†’ 500Kbps)
- **ëª¨ë“œ**: `ideal` + `min`/`max` ì œì•½ ì¡°ê±´
- **ì¹´ë©”ë¼**: ì „ë©´ ì¹´ë©”ë¼ (`facingMode: 'user'`)

**ìë™ ì¬ì¡°ì •:**
- ì°¸ì—¬ì ìˆ˜ê°€ ë³€ê²½ë˜ë©´ ìë™ìœ¼ë¡œ í•´ìƒë„/í”„ë ˆì„ë ˆì´íŠ¸ ì¬ì¡°ì •
- ê¸°ì¡´ ìŠ¤íŠ¸ë¦¼ê³¼ ëª©í‘œ í•´ìƒë„ ì°¨ì´ê°€ 20% ì´ìƒì´ë©´ ì¬íšë“

#### 2. ë¹„íŠ¸ë ˆì´íŠ¸ ì œí•œ

**êµ¬í˜„:**
```typescript
// webrtcService.ts
private async applyBitrateLimit(
  peerConnection: RTCPeerConnection,
  maxBitrate: number
): Promise<void> {
  const senders = peerConnection.getSenders()
  for (const sender of senders) {
    if (sender.track && sender.track.kind === 'video') {
      const params = sender.getParameters()
      if (!params.encodings) {
        params.encodings = [{}]
      }
      
      // ê° ì¸ì½”ë”©ì— ë¹„íŠ¸ë ˆì´íŠ¸ ì œí•œ ì ìš©
      params.encodings.forEach((encoding: any) => {
        encoding.maxBitrate = maxBitrate
      })
      
      await sender.setParameters(params)
    }
  }
}
```

**ì ìš© ì‹œì :**
- `setLocalStream()` í˜¸ì¶œ ì‹œ ëª¨ë“  ê¸°ì¡´ PeerConnectionì— ì ìš©
- ìƒˆë¡œìš´ PeerConnection ìƒì„± ì‹œ ìë™ ì ìš©

#### 3. ì½”ë± ì„¤ì •

**í˜„ì¬ ìƒíƒœ: ëª…ì‹œì  ì½”ë± ì„¤ì • ì—†ìŒ**

WebRTCëŠ” ë¸Œë¼ìš°ì €ê°€ ìë™ìœ¼ë¡œ ì½”ë±ì„ ì„ íƒí•©ë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ:
- **ë¹„ë””ì˜¤ ì½”ë±**: 
  - Chrome/Edge: VP8 ë˜ëŠ” VP9 (ê¸°ë³¸ê°’)
  - Safari: H.264 (ê¸°ë³¸ê°’)
  - Firefox: VP8 (ê¸°ë³¸ê°’)
- **ì˜¤ë””ì˜¤ ì½”ë±**: 
  - Opus (ëŒ€ë¶€ë¶„ì˜ ë¸Œë¼ìš°ì €)
  - G.711 (ì¼ë¶€ ê²½ìš°)

**ì½”ë±ì„ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •í•˜ë ¤ë©´:**
```typescript
// RTCRtpSenderë¥¼ í†µí•´ ì½”ë± ì„¤ì • ê°€ëŠ¥
const sender = peerConnection.getSenders().find(s => s.track?.kind === 'video')
if (sender) {
  const params = sender.getParameters()
  params.codecs = params.codecs.filter(codec => 
    codec.mimeType.includes('VP8') || codec.mimeType.includes('H264')
  )
  await sender.setParameters(params)
}
```

### ë¶€í•˜ ë¶„ì„

**5ëª… ì°¸ì—¬ ì‹œ ì˜ˆìƒ ë¶€í•˜:**

```
ê° ì‚¬ìš©ìë‹¹:
- ì†¡ì‹ : 1ê°œ ìŠ¤íŠ¸ë¦¼ (ìì‹ ì˜ ë¹„ë””ì˜¤)
- ìˆ˜ì‹ : 4ê°œ ìŠ¤íŠ¸ë¦¼ (ë‹¤ë¥¸ ì°¸ì—¬ìë“¤ì˜ ë¹„ë””ì˜¤)
- ì´ ì²˜ë¦¬: 5ê°œ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼

5ëª… ê¸°ì¤€ (480x270 @ 15fps, 500Kbps):
- ì†¡ì‹  ëŒ€ì—­í­: 500Kbps
- ìˆ˜ì‹  ëŒ€ì—­í­: 500Kbps Ã— 4 = 2Mbps
- ì´ ëŒ€ì—­í­: 2.5Mbps (ì†¡ì‹  + ìˆ˜ì‹ )
- CPU ë¶€í•˜: ì¤‘ê°„ (ì €í•´ìƒë„/ì €í”„ë ˆì„ë ˆì´íŠ¸ë¡œ ì™„í™”)

ê¸°ì¡´ ì„¤ì • (1280x720 @ 30fps, ~2Mbps) ëŒ€ë¹„:
- ëŒ€ì—­í­: ì•½ 80% ê°ì†Œ (2.5Mbps vs 10Mbps)
- CPU ë¶€í•˜: ì•½ 70% ê°ì†Œ
```

**3ëª… ì°¸ì—¬ ì‹œ ì˜ˆìƒ ë¶€í•˜:**

```
ê° ì‚¬ìš©ìë‹¹:
- ì†¡ì‹ : 1ê°œ ìŠ¤íŠ¸ë¦¼
- ìˆ˜ì‹ : 2ê°œ ìŠ¤íŠ¸ë¦¼
- ì´ ì²˜ë¦¬: 3ê°œ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼

3ëª… ê¸°ì¤€ (640x360 @ 20fps, 1Mbps):
- ì†¡ì‹  ëŒ€ì—­í­: 1Mbps
- ìˆ˜ì‹  ëŒ€ì—­í­: 1Mbps Ã— 2 = 2Mbps
- ì´ ëŒ€ì—­í­: 3Mbps
- CPU ë¶€í•˜: ë‚®ìŒ-ì¤‘ê°„
```

### ë™ì  í’ˆì§ˆ ì¡°ì •ì˜ ì¥ì 

1. **ìë™ ìµœì í™”**
   - ì°¸ì—¬ì ìˆ˜ì— ë”°ë¼ ìë™ìœ¼ë¡œ í’ˆì§ˆ ì¡°ì •
   - ë„¤íŠ¸ì›Œí¬ ë¶€í•˜ ë° CPU ì‚¬ìš©ëŸ‰ ìµœì†Œí™”

2. **í™•ì¥ì„±**
   - ì†Œê·œëª¨ ê·¸ë£¹: ê³ í™”ì§ˆ ìœ ì§€
   - ëŒ€ê·œëª¨ ê·¸ë£¹: ì•ˆì •ì ì¸ ì—°ê²° ìœ ì§€

3. **ì‚¬ìš©ì ê²½í—˜**
   - ì—°ê²° ì•ˆì •ì„± í–¥ìƒ
   - ì§€ì—° ì‹œê°„ ê°ì†Œ
   - ë°°í„°ë¦¬ ì†Œëª¨ ê°ì†Œ (ëª¨ë°”ì¼)

### ì¶”ê°€ ê°œì„  ê¶Œì¥ ì‚¬í•­

1. **ì½”ë± ëª…ì‹œì  ì„¤ì •**
   - VP8 ë˜ëŠ” H.264 ìš°ì„ ìˆœìœ„ ì„¤ì •
   - ë¸Œë¼ìš°ì € í˜¸í™˜ì„± ê³ ë ¤

2. **ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ê¸°ë°˜ ì¡°ì •**
   - RTT (Round Trip Time) ëª¨ë‹ˆí„°ë§
   - íŒ¨í‚· ì†ì‹¤ë¥  ê¸°ë°˜ í’ˆì§ˆ ì¡°ì •
   - `RTCPeerConnection.getStats()` í™œìš©

3. **Simulcast ì§€ì›** (ì„ íƒì‚¬í•­)
   - ì—¬ëŸ¬ í•´ìƒë„ ë™ì‹œ ì „ì†¡
   - ìˆ˜ì‹ ìê°€ ë„¤íŠ¸ì›Œí¬ ìƒíƒœì— ë”°ë¼ ì„ íƒ

---

## P2P êµ¬ì¡° ë¶„ì„

### í˜„ì¬ êµ¬ì¡°: **ìˆœìˆ˜ P2P (STUNë§Œ ì‚¬ìš©)**

```typescript
// webrtcService.ts (ë¼ì¸ 35-50)
constructor() {
  this.config = {
    iceServers: [
      // Google STUN ì„œë²„ (ì£¼ ì„œë²„)
      { urls: 'stun:stun.l.google.com:19302' },
      { urls: 'stun:stun1.l.google.com:19302' },
      // ëŒ€ì•ˆ STUN ì„œë²„ (ë¶€í•˜ ë¶„ì‚°)
      { urls: 'stun:stun2.l.google.com:19302' },
      { urls: 'stun:stun3.l.google.com:19302' },
      { urls: 'stun:stun4.l.google.com:19302' },
      // Mozilla STUN ì„œë²„ (ëŒ€ì•ˆ)
      { urls: 'stun:stun.mozilla.org:3478' },
    ],
    iceCandidatePoolSize: 0, // 0ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ í•„ìš”í•  ë•Œë§Œ ìˆ˜ì§‘
  }
}
```

### âš ï¸ Google STUN ì„œë²„ ì œí•œì‚¬í•­

**ì¤‘ìš” ì‚¬í•­:**
1. **ìš©ë„ ì œí•œ**: Google STUN ì„œë²„ëŠ” **í…ŒìŠ¤íŠ¸ ë° ê°œë°œ ëª©ì **ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤
2. **ìƒì—…ì  ì‚¬ìš©**: ìƒì—…ì  ë˜ëŠ” ëŒ€ê·œëª¨ ì„œë¹„ìŠ¤ì—ì„œëŠ” ì œí•œì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤
3. **Rate Limiting**: ë‹¤ìˆ˜ì˜ ì‚¬ìš©ìê°€ ë™ì‹œì— ì ‘ê·¼í•  ê²½ìš°:
   - ì„±ëŠ¥ ì €í•˜ ê°€ëŠ¥
   - ì—°ê²° ì‹¤íŒ¨ ê°€ëŠ¥
   - ì‘ë‹µ ì§€ì—° ê°€ëŠ¥
4. **ë¬´ë£Œ ì„œë¹„ìŠ¤**: SLA(ì„œë¹„ìŠ¤ ìˆ˜ì¤€ í˜‘ì•½) ì—†ìŒ, ì–¸ì œë“ ì§€ ì¤‘ë‹¨ ê°€ëŠ¥

**í˜„ì¬ ì—ëŸ¬ì™€ì˜ ê´€ê³„:**
- `TypeError: (intermediate value) is not a function` ì—ëŸ¬ëŠ” ì£¼ë¡œ ë¸Œë¼ìš°ì € í˜¸í™˜ì„± ë¬¸ì œ
- í•˜ì§€ë§Œ STUN ì„œë²„ ì‘ë‹µ ì§€ì—°/ì‹¤íŒ¨ ì‹œ PeerConnection ìƒì„±ì´ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŒ
- `iceCandidatePoolSize: 10` ì„¤ì •ìœ¼ë¡œ ì¸í•´ ê° PeerConnectionë§ˆë‹¤ 10ê°œì˜ candidateë¥¼ ë¯¸ë¦¬ ìˆ˜ì§‘í•˜ë ¤ê³  ì‹œë„ â†’ STUN ì„œë²„ ë¶€í•˜ ì¦ê°€

**ê°œì„  ì‚¬í•­:**
- `iceCandidatePoolSize: 0`ìœ¼ë¡œ ë³€ê²½ (í•„ìš”í•  ë•Œë§Œ ìˆ˜ì§‘)
- ì—¬ëŸ¬ STUN ì„œë²„ ì¶”ê°€ (ë¶€í•˜ ë¶„ì‚°)
- Mozilla STUN ì„œë²„ ì¶”ê°€ (ëŒ€ì•ˆ)

### P2P ì—°ê²° ë°©ì‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    P2P ì—°ê²° êµ¬ì¡°                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ì‚¬ìš©ì A (NAT ë’¤)                    ì‚¬ìš©ì B (NAT ë’¤)
      â”‚                                    â”‚
      â”‚ 1. STUN ì„œë²„ì— ê³µì¸ IP ì¡°íšŒ        â”‚
      â”‚    â””â”€â–º stun.l.google.com          â”‚
      â”‚                                    â”‚
      â”‚                                    â”‚ 2. STUN ì„œë²„ì— ê³µì¸ IP ì¡°íšŒ
      â”‚                                    â”‚    â””â”€â–º stun.l.google.com
      â”‚                                    â”‚
      â”‚ 3. Signalingì„ í†µí•´ ê³µì¸ IP êµí™˜   â”‚
      â”‚    â””â”€â–º Supabase Realtime         â”‚
      â”‚                                    â”‚
      â”‚ 4. ì§ì ‘ P2P ì—°ê²° ì‹œë„              â”‚
      â”‚    â””â”€â–º UDP/TCP ì§ì ‘ ì—°ê²°         â”‚
      â”‚                                    â”‚
      â”‚ 5. ì—°ê²° ì„±ê³µ ì‹œ ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ êµí™˜ â”‚
      â”‚    â””â”€â–º ì§ì ‘ ì „ì†¡ (ì„œë²„ ê²½ìœ  ì—†ìŒ)  â”‚
      â”‚                                    â”‚
```

### P2P ì—°ê²° ì„±ê³µ ì¡°ê±´

âœ… **ì„±ê³µí•˜ëŠ” ê²½ìš°:**
- ë‘ ì‚¬ìš©ìê°€ ê°™ì€ ë„¤íŠ¸ì›Œí¬ì— ìˆìŒ
- í•œ ì‚¬ìš©ìê°€ ê³µì¸ IPë¥¼ ê°€ì§€ê³  ìˆìŒ
- NATê°€ "Cone NAT"ì´ê³  í¬íŠ¸ í¬ì›Œë”©ì´ ê°€ëŠ¥í•œ ê²½ìš°

âŒ **ì‹¤íŒ¨í•˜ëŠ” ê²½ìš°:**
- ë‘ ì‚¬ìš©ìê°€ ëª¨ë‘ ëŒ€ì¹­í˜• NAT ë’¤ì— ìˆìŒ
- ë°©í™”ë²½ì´ UDP/TCP í¬íŠ¸ë¥¼ ì°¨ë‹¨í•¨
- ì—„ê²©í•œ ê¸°ì—… ë„¤íŠ¸ì›Œí¬ í™˜ê²½

### TURN ì„œë²„ê°€ í•„ìš”í•œ ê²½ìš°

í˜„ì¬ ì½”ë“œì—ëŠ” **TURN ì„œë²„ê°€ ì—†ìŠµë‹ˆë‹¤**. ë‹¤ìŒ ê²½ìš°ì— TURN ì„œë²„ê°€ í•„ìš”í•©ë‹ˆë‹¤:

1. **ëŒ€ì¹­í˜• NAT í™˜ê²½**: ë‘ ì‚¬ìš©ìê°€ ëª¨ë‘ ëŒ€ì¹­í˜• NAT ë’¤ì— ìˆëŠ” ê²½ìš°
2. **ì—„ê²©í•œ ë°©í™”ë²½**: UDP/TCP ì§ì ‘ ì—°ê²°ì´ ë¶ˆê°€ëŠ¥í•œ ê²½ìš°
3. **ê¸°ì—… ë„¤íŠ¸ì›Œí¬**: ë³´ì•ˆ ì •ì±…ìœ¼ë¡œ ì¸í•´ ì§ì ‘ ì—°ê²°ì´ ì°¨ë‹¨ëœ ê²½ìš°

**TURN ì„œë²„ ì¶”ê°€ ì˜ˆì‹œ:**
```typescript
this.config = {
  iceServers: [
    { urls: 'stun:stun.l.google.com:19302' },
    { urls: 'stun:stun1.l.google.com:19302' },
    {
      urls: 'turn:your-turn-server.com:3478',
      username: 'your-username',
      credential: 'your-password'
    }
  ],
  iceCandidatePoolSize: 10,
}
```

### ê²°ë¡ 

**í˜„ì¬ êµ¬ì¡°ëŠ” ìˆœìˆ˜ P2Pì…ë‹ˆë‹¤:**
- âœ… STUN ì„œë²„ë§Œ ì‚¬ìš© (ê³µì¸ IP ì¡°íšŒìš©)
- âœ… ì§ì ‘ ì—°ê²° ì‹œë„ (ì„œë²„ ê²½ìœ  ì—†ìŒ)
- âŒ TURN ì„œë²„ ì—†ìŒ (ë¦´ë ˆì´ ì„œë²„ ì—†ìŒ)

**ì¥ì :**
- ë‚®ì€ ì§€ì—°ì‹œê°„ (ì§ì ‘ ì—°ê²°)
- ì„œë²„ ë¶€í•˜ ì—†ìŒ
- ë¹„ìš© ì ˆê° (TURN ì„œë²„ ë¶ˆí•„ìš”)

**ë‹¨ì :**
- ì¼ë¶€ ë„¤íŠ¸ì›Œí¬ í™˜ê²½ì—ì„œ ì—°ê²° ì‹¤íŒ¨ ê°€ëŠ¥
- NAT ë’¤ì— ìˆëŠ” ì‚¬ìš©ì ê°„ ì—°ê²°ì´ ì–´ë ¤ìš¸ ìˆ˜ ìˆìŒ

---

## ì„œë¹„ìŠ¤ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WebRTCService (Singleton)                     â”‚
â”‚                    (webrtcService ì¸ìŠ¤í„´ìŠ¤)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚                     â”‚
        â–¼                     â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ë‚´ë¶€ ìƒíƒœ    â”‚    â”‚   ì½œë°± ì‹œìŠ¤í…œ   â”‚    â”‚   ì„¤ì • ê´€ë¦¬    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                     â”‚                     â”‚
        â”‚                     â”‚                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                â”‚   â”‚                 â”‚   â”‚                â”‚
â”‚ peerConnectionsâ”‚   â”‚connectionState  â”‚   â”‚   config       â”‚
â”‚   Map<userId,  â”‚   â”‚   Callbacks     â”‚   â”‚  WebRTCConfig  â”‚
â”‚  RTCPeerConn>  â”‚   â”‚   Set<Callback> â”‚   â”‚  - iceServers  â”‚
â”‚                â”‚   â”‚                 â”‚   â”‚  - poolSize    â”‚
â”‚ localStream    â”‚   â”‚remoteStream     â”‚   â”‚                â”‚
â”‚ MediaStream    â”‚   â”‚   Callbacks     â”‚   â”‚                â”‚
â”‚    | null      â”‚   â”‚   Set<Callback> â”‚   â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### í´ë˜ìŠ¤ êµ¬ì¡°

```typescript
class WebRTCService {
  // ë‚´ë¶€ ìƒíƒœ
  private peerConnections: Map<string, RTCPeerConnection>
  private localStream: MediaStream | null
  private config: WebRTCConfig
  
  // ì½œë°± ì‹œìŠ¤í…œ
  private connectionStateCallbacks: Set<ConnectionStateChangeCallback>
  private remoteStreamCallbacks: Set<RemoteStreamCallback>
  
  // ì£¼ìš” ë©”ì„œë“œ
  createPeerConnection(userId: string): Promise<RTCPeerConnection>
  createOffer(userId: string): Promise<RTCSessionDescriptionInit>
  createAnswer(userId: string, offer: RTCSessionDescriptionInit): Promise<RTCSessionDescriptionInit>
  handleAnswer(userId: string, answer: RTCSessionDescriptionInit): Promise<void>
  addIceCandidate(userId: string, candidate: RTCIceCandidateInit): Promise<void>
  closeConnection(userId: string): Promise<void>
  closeAllConnections(): Promise<void>
  setLocalStream(stream: MediaStream): Promise<void>
  removeLocalStream(): void
  onConnectionStateChange(callback: ConnectionStateChangeCallback): () => void
  onRemoteStream(callback: RemoteStreamCallback): () => void
}
```

---

## ì£¼ìš” ë©”ì„œë“œ êµ¬ì¡°

### 1. ì—°ê²° ìƒì„± ë° ê´€ë¦¬

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ createPeerConnection(userId)                 â”‚
â”‚ â”œâ”€ ê¸°ì¡´ ì—°ê²° í™•ì¸ (ë‹«íŒ ìƒíƒœë©´ ì •ë¦¬)          â”‚
â”‚ â”œâ”€ ìƒì„± ì‹œë„ íšŸìˆ˜ ì œí•œ (ìµœëŒ€ 5íšŒ)            â”‚
â”‚ â”œâ”€ RTCPeerConnection ìƒì„±                    â”‚
â”‚ â”œâ”€ ë¡œì»¬ ìŠ¤íŠ¸ë¦¼ ì¶”ê°€                          â”‚
â”‚ â”œâ”€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •                        â”‚
â”‚ â”‚  â”œâ”€ onicecandidate                        â”‚
â”‚ â”‚  â”œâ”€ oniceconnectionstatechange            â”‚
â”‚ â”‚  â”œâ”€ onconnectionstatechange               â”‚
â”‚ â”‚  â””â”€ ontrack (ì›ê²© ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹ )             â”‚
â”‚ â””â”€ Mapì— ì €ì¥                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Offer/Answer ìƒì„± ë° ì²˜ë¦¬

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ createOffer(userId)                          â”‚
â”‚ â”œâ”€ createPeerConnection í˜¸ì¶œ                 â”‚
â”‚ â”œâ”€ ìƒíƒœ í™•ì¸ (signalingState)                â”‚
â”‚ â”œâ”€ ì¤‘ë³µ Offer ë°©ì§€                           â”‚
â”‚ â”œâ”€ peerConnection.createOffer()             â”‚
â”‚ â””â”€ setLocalDescription(offer)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ createAnswer(userId, offer)                  â”‚
â”‚ â”œâ”€ createPeerConnection í˜¸ì¶œ                 â”‚
â”‚ â”œâ”€ ìƒíƒœ í™•ì¸                                 â”‚
â”‚ â”œâ”€ ì¤‘ë³µ Answer ë°©ì§€                          â”‚
â”‚ â”œâ”€ setRemoteDescription(offer)               â”‚
â”‚ â”œâ”€ peerConnection.createAnswer()            â”‚
â”‚ â””â”€ setLocalDescription(answer)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ handleAnswer(userId, answer)                 â”‚
â”‚ â”œâ”€ PeerConnection ì¡°íšŒ                      â”‚
â”‚ â”œâ”€ ìƒíƒœ í™•ì¸                                 â”‚
â”‚ â”œâ”€ ì¤‘ë³µ Answer ë°©ì§€                          â”‚
â”‚ â””â”€ setRemoteDescription(answer)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. ICE Candidate ì²˜ë¦¬

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ addIceCandidate(userId, candidate)           â”‚
â”‚ â”œâ”€ PeerConnection ì¡°íšŒ                      â”‚
â”‚ â”œâ”€ ë‹«íŒ ìƒíƒœ í™•ì¸ (ë¬´ì‹œ)                     â”‚
â”‚ â””â”€ peerConnection.addIceCandidate()         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. ì—°ê²° ì¢…ë£Œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ closeConnection(userId)                      â”‚
â”‚ â”œâ”€ ëª¨ë“  íŠ¸ë™ ì •ì§€                            â”‚
â”‚ â”œâ”€ peerConnection.close()                   â”‚
â”‚ â”œâ”€ Mapì—ì„œ ì œê±°                              â”‚
â”‚ â”œâ”€ ìƒì„± ì¹´ìš´í„° ë¦¬ì…‹                          â”‚
â”‚ â””â”€ notifyRemoteStream(userId, null)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ closeAllConnections()                        â”‚
â”‚ â””â”€ ëª¨ë“  userIdì— ëŒ€í•´ closeConnection í˜¸ì¶œ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5. ìŠ¤íŠ¸ë¦¼ ê´€ë¦¬

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ setLocalStream(stream)                       â”‚
â”‚ â”œâ”€ localStream ì €ì¥                          â”‚
â”‚ â””â”€ ëª¨ë“  PeerConnectionì— íŠ¸ë™ ì¶”ê°€/êµì²´     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ removeLocalStream()                          â”‚
â”‚ â””â”€ ëª¨ë“  íŠ¸ë™ ì •ì§€ ë° localStream ì œê±°         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6. ì½œë°± ì‹œìŠ¤í…œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ onConnectionStateChange(callback)            â”‚
â”‚ â””â”€ connectionStateCallbacksì— ì¶”ê°€           â”‚
â”‚     â””â”€ unsubscribe í•¨ìˆ˜ ë°˜í™˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ onRemoteStream(callback)                     â”‚
â”‚ â””â”€ remoteStreamCallbacksì— ì¶”ê°€              â”‚
â”‚     â””â”€ unsubscribe í•¨ìˆ˜ ë°˜í™˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ notifyConnectionStateChange(userId, state)    â”‚
â”‚ â””â”€ ëª¨ë“  ì½œë°±ì— ìƒíƒœ ë³€ê²½ ì•Œë¦¼                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ notifyRemoteStream(userId, stream)           â”‚
â”‚ â””â”€ ëª¨ë“  ì½œë°±ì— ìŠ¤íŠ¸ë¦¼ ì•Œë¦¼                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ë°ì´í„° íë¦„

### WebRTC ì—°ê²° ì„¤ì • íë¦„

```
ì‚¬ìš©ì A (Offer ìƒì„±ì)              ì‚¬ìš©ì B (Answer ìƒì„±ì)
      â”‚                                    â”‚
      â”‚ 1. createOffer()                   â”‚
      â”‚    â””â”€â–º createPeerConnection()      â”‚
      â”‚    â””â”€â–º createOffer()               â”‚
      â”‚    â””â”€â–º setLocalDescription()       â”‚
      â”‚                                    â”‚
      â”‚ 2. SignalingService.sendOffer()    â”‚
      â”‚    â””â”€â–º Supabase Realtime          â”‚
      â”‚                                    â”‚
      â”‚                                    â”‚ 3. SignalingService
      â”‚                                    â”‚    handleOffer()
      â”‚                                    â”‚    â””â”€â–º createAnswer()
      â”‚                                    â”‚        â””â”€â–º setRemoteDescription(offer)
      â”‚                                    â”‚        â””â”€â–º createAnswer()
      â”‚                                    â”‚        â””â”€â–º setLocalDescription(answer)
      â”‚                                    â”‚
      â”‚                                    â”‚ 4. SignalingService.sendAnswer()
      â”‚                                    â”‚    â””â”€â–º Supabase Realtime
      â”‚                                    â”‚
      â”‚ 5. SignalingService                â”‚
      â”‚    handleAnswer()                  â”‚
      â”‚    â””â”€â–º handleAnswer()              â”‚
      â”‚        â””â”€â–º setRemoteDescription(answer)
      â”‚                                    â”‚
      â”‚ 6. ICE Candidates êµí™˜             â”‚
      â”‚    (ì–‘ë°©í–¥, STUN ì„œë²„ í†µí•´)         â”‚
      â”‚                                    â”‚
      â”‚ 7. P2P ì—°ê²° ì„±ê³µ                    â”‚
      â”‚    â””â”€â–º ì§ì ‘ ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ì „ì†¡     â”‚
      â”‚                                    â”‚
      â”‚ 8. ontrack ì´ë²¤íŠ¸                  â”‚
      â”‚    â””â”€â–º notifyRemoteStream()       â”‚
      â”‚        â””â”€â–º CrewMeetingView        â”‚
      â”‚            â””â”€â–º ë¹„ë””ì˜¤ ë Œë”ë§       â”‚
```

### ì™¸ë¶€ ì„œë¹„ìŠ¤ì™€ì˜ ê´€ê³„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Signaling    â”‚         â”‚  WebRTC      â”‚         â”‚  CrewMeeting â”‚
â”‚  Service     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  Service     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚    View      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                       â”‚                       â”‚
        â”‚                       â”‚                       â”‚
        â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase     â”‚         â”‚  Browser     â”‚         â”‚  React       â”‚
â”‚ Realtime     â”‚         â”‚  WebRTC API  â”‚         â”‚  Component   â”‚
â”‚  Channels    â”‚         â”‚              â”‚         â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ìƒíƒœ ê´€ë¦¬ ë° ë³´í˜¸ ë©”ì»¤ë‹ˆì¦˜

### 1. PeerConnection ìƒì„± ë³´í˜¸

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ ê¸°ì¡´ ì—°ê²° ìƒíƒœ í™•ì¸ (closed/failed ê°ì§€)    â”‚
â”‚ â€¢ ìƒì„± ì‹œë„ íšŸìˆ˜ ì œí•œ (ìµœëŒ€ 5íšŒ)              â”‚
â”‚ â€¢ window ê°ì²´ì— ì¹´ìš´í„° ì €ì¥                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**êµ¬í˜„:**
```typescript
// ìƒì„± ì‹œë„ íšŸìˆ˜ ì œí•œ
const createKey = `create_${userId}`
const createCount = (window as any)[createKey] || 0
if (createCount >= 5) {
  throw new Error(`PeerConnection ìƒì„± ì‹œë„ íšŸìˆ˜ ì´ˆê³¼: ${userId} (ìµœëŒ€ 5íšŒ)`)
}
(window as any)[createKey] = createCount + 1
```

### 2. ë™ì‹œ ì‹¤í–‰ ë°©ì§€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ connecting_${userId} í”Œë˜ê·¸ ì‚¬ìš©           â”‚
â”‚ â€¢ ì´ë¯¸ ì—°ê²° ì‹œë„ ì¤‘ì´ë©´ ìŠ¤í‚µ                  â”‚
â”‚ â€¢ finally ë¸”ë¡ìœ¼ë¡œ í”Œë˜ê·¸ í•´ì œ ë³´ì¥          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**êµ¬í˜„:**
```typescript
const connectingKey = `connecting_${participant.userId}`
if ((window as any)[connectingKey]) {
  console.warn(`âš ï¸ ì´ë¯¸ ì—°ê²° ì‹œë„ ì¤‘ì…ë‹ˆë‹¤`)
  continue
}
(window as any)[connectingKey] = true

try {
  // ì—°ê²° ë¡œì§
} finally {
  (window as any)[connectingKey] = false
}
```

### 3. ìƒíƒœ ê²€ì¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ signalingState í™•ì¸                       â”‚
â”‚ â€¢ ì¤‘ë³µ Offer/Answer ë°©ì§€                    â”‚
â”‚ â€¢ ë‹«íŒ ì—°ê²°ì—ì„œ ICE candidate ë¬´ì‹œ           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**êµ¬í˜„:**
```typescript
// Offer ìƒì„± ì „ ìƒíƒœ í™•ì¸
if (hasLocalDescription && peerConnection.localDescription?.type === 'offer') {
  return peerConnection.localDescription // ì¤‘ë³µ ë°©ì§€
}

// signalingState ê²€ì¦
if (signalingState !== 'stable' && signalingState !== 'have-local-offer') {
  // ì¬ìƒì„± ë˜ëŠ” ì—ëŸ¬ ì²˜ë¦¬
}
```

### 4. ë¦¬ì†ŒìŠ¤ ì •ë¦¬

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ ëª¨ë“  íŠ¸ë™ ì •ì§€                             â”‚
â”‚ â€¢ PeerConnection.close()                    â”‚
â”‚ â€¢ Mapì—ì„œ ì œê±°                               â”‚
â”‚ â€¢ ì¹´ìš´í„° ë¦¬ì…‹                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**êµ¬í˜„:**
```typescript
async closeConnection(userId: string): Promise<void> {
  const peerConnection = this.peerConnections.get(userId)
  if (peerConnection) {
    // ëª¨ë“  íŠ¸ë™ ì •ì§€
    peerConnection.getSenders().forEach(sender => {
      if (sender.track) {
        sender.track.stop()
      }
    })
    
    // ì—°ê²° ì¢…ë£Œ
    peerConnection.close()
    this.peerConnections.delete(userId)
    
    // ì¹´ìš´í„° ë¦¬ì…‹
    const createKey = `create_${userId}`
    if ((window as any)[createKey]) {
      (window as any)[createKey] = 0
    }
  }
}
```

---

## ìš”ì•½

### ë¯¸ë””ì–´ ì„¤ì •
- **í•´ìƒë„**: ì°¸ì—¬ì ìˆ˜ì— ë”°ë¼ ë™ì  ì¡°ì •
  - 1-2ëª…: 1280x720 (HD)
  - 3-4ëª…: 640x360 (SD)
  - 5ëª… ì´ìƒ: 480x270 (ì €í•´ìƒë„)
- **í”„ë ˆì„ë ˆì´íŠ¸**: ì°¸ì—¬ì ìˆ˜ì— ë”°ë¼ ë™ì  ì¡°ì •
  - 1-2ëª…: 30fps
  - 3-4ëª…: 20fps
  - 5ëª… ì´ìƒ: 15fps
- **ë¹„íŠ¸ë ˆì´íŠ¸**: ì°¸ì—¬ì ìˆ˜ì— ë”°ë¼ ë™ì  ì¡°ì •
  - 1-2ëª…: 2Mbps
  - 3-4ëª…: 1Mbps
  - 5ëª… ì´ìƒ: 500Kbps
- **ì½”ë±**: ë¸Œë¼ìš°ì € ìë™ ì„ íƒ (ëª…ì‹œì  ì„¤ì • ì—†ìŒ)

### P2P êµ¬ì¡°
- âœ… **ìˆœìˆ˜ P2P**: STUN ì„œë²„ë§Œ ì‚¬ìš©
- âœ… **ì§ì ‘ ì—°ê²°**: ì„œë²„ ê²½ìœ  ì—†ì´ ì§ì ‘ ë¯¸ë””ì–´ ì „ì†¡
- âŒ **TURN ì„œë²„ ì—†ìŒ**: ì¼ë¶€ ë„¤íŠ¸ì›Œí¬ í™˜ê²½ì—ì„œ ì—°ê²° ì‹¤íŒ¨ ê°€ëŠ¥

### ì•„í‚¤í…ì²˜ íŠ¹ì§•
- ì‹±ê¸€í†¤ íŒ¨í„´ìœ¼ë¡œ ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ ê´€ë¦¬
- Map ê¸°ë°˜ìœ¼ë¡œ ë‹¤ì¤‘ ì‚¬ìš©ì ì—°ê²° ê´€ë¦¬
- ì½œë°± ì‹œìŠ¤í…œìœ¼ë¡œ ìƒíƒœ ë³€ê²½ ì•Œë¦¼
- ê°•ë ¥í•œ ìƒíƒœ ë³´í˜¸ ë©”ì»¤ë‹ˆì¦˜

---

## ê°œì„  ê¶Œì¥ ì‚¬í•­

### 1. ì½”ë± ëª…ì‹œì  ì„¤ì •
```typescript
// RTCRtpSenderë¥¼ í†µí•´ ì½”ë± ìš°ì„ ìˆœìœ„ ì„¤ì •
const sender = peerConnection.getSenders().find(s => s.track?.kind === 'video')
if (sender) {
  const params = sender.getParameters()
  // VP8 ìš°ì„ , H.264 ëŒ€ì²´
  params.codecs = params.codecs.sort((a, b) => {
    if (a.mimeType.includes('VP8')) return -1
    if (b.mimeType.includes('VP8')) return 1
    if (a.mimeType.includes('H264')) return -1
    if (b.mimeType.includes('H264')) return 1
    return 0
  })
  await sender.setParameters(params)
}
```

### 2. TURN ì„œë²„ ì¶”ê°€ (ì„ íƒì‚¬í•­)
```typescript
iceServers: [
  { urls: 'stun:stun.l.google.com:19302' },
  { urls: 'stun:stun1.l.google.com:19302' },
  {
    urls: 'turn:your-turn-server.com:3478',
    username: 'your-username',
    credential: 'your-password'
  }
]
```

### 3. í”„ë ˆì„ë ˆì´íŠ¸ ì œì•½ ì¡°ê±´ ì¶”ê°€
```typescript
frameRate: { ideal: 30, max: 30, min: 15 }
```

### 4. í•´ìƒë„ ì œì•½ ì¡°ê±´ ê°•í™”
```typescript
width: { ideal: 1280, min: 640, max: 1920 },
height: { ideal: 720, min: 360, max: 1080 }
```

---

**ë¬¸ì„œ ì‘ì„±ì¼**: 2025-01-25  
**ë²„ì „**: 1.0.0

